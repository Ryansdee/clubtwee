<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Menu Beheer - Club Twee</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'menu-bg': '#E5E4E2',
            'menu-cream': '#f5f0e8',
            'menu-burgundy': '#580712',
            'menu-brown': '#3d2314'
          },
          fontFamily: {
            'bebas': ['Bebas Neue', 'cursive']
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
  <style>
    .font-bebas { font-family: 'Bebas Neue', sans-serif; }
  </style>
</head>
<body class="bg-menu-bg min-h-screen">
  <!-- Header -->
  <header class="bg-menu-burgundy text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-6 py-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <div class="bg-white bg-opacity-20 p-3 rounded-full">
            <i class="fas fa-utensils text-2xl"></i>
          </div>
          <div>
            <h1 class="text-3xl md:text-4xl font-bebas uppercase tracking-wide">Menu Beheer</h1>
            <p class="text-white text-opacity-80">Club Twee - Admin Panel</p>
          </div>
        </div>
        <div class="hidden md:flex items-center space-x-4">
          <div class="bg-white bg-opacity-20 px-4 py-2 rounded-full">
            <span id="total-items" class="font-bebas text-xl">0 items</span>
          </div>
          <div class="bg-white bg-opacity-20 px-4 py-2 rounded-full">
            <span id="total-categories" class="font-bebas text-xl">0 categorieën</span>
          </div>
          <a href="./menu.html" target="_blank" class="bg-white text-menu-burgundy px-4 py-2 rounded-full font-bebas hover:bg-opacity-90 transition-colors">
            <i class="fas fa-eye mr-2"></i>Bekijk Menu
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-xl p-8 flex flex-col items-center space-y-4">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-menu-burgundy"></div>
      <p class="font-bebas text-xl text-menu-brown">Laden...</p>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div id="toast-container" class="fixed top-4 right-4 z-40 space-y-2"></div>

  <div class="max-w-7xl mx-auto px-6 py-8">
    <!-- Add Category Section -->
    <div class="bg-menu-cream rounded-2xl shadow-lg p-6 mb-8 border-2 border-menu-burgundy">
      <div class="flex items-center space-x-4 mb-6">
        <div class="bg-menu-burgundy p-3 rounded-full text-white">
          <i class="fas fa-plus text-xl"></i>
        </div>
        <h2 class="text-2xl font-bebas uppercase text-menu-burgundy">Nieuwe Categorie Toevoegen</h2>
      </div>
      
      <form id="category-form" class="flex flex-col md:flex-row gap-4">
        <div class="flex-1">
          <input 
            id="new-category-name" 
            type="text"
            placeholder="Categorienaam (Broodjes, Dranken, Desserts,...)" 
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-menu-burgundy focus:outline-none transition-colors text-lg"
            required
          >
        </div>
        <button 
          type="submit"
          class="bg-menu-burgundy text-white px-8 py-3 rounded-xl font-bebas uppercase text-lg hover:bg-menu-brown transition-colors flex items-center space-x-2"
        >
          <i class="fas fa-plus"></i>
          <span>Toevoegen</span>
        </button>
      </form>
    </div>

    <!-- Menu Categories -->
    <div id="menu-container" class="space-y-8">
      <!-- Categories will be loaded here -->
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="text-center py-16 hidden">
      <div class="bg-menu-cream rounded-2xl shadow-lg p-12 border-2 border-menu-burgundy">
        <i class="fas fa-utensils text-6xl text-menu-burgundy opacity-50 mb-6"></i>
        <h3 class="text-3xl font-bebas uppercase text-menu-burgundy mb-4">Geen categorieën gevonden</h3>
        <p class="text-gray-600 text-lg mb-8">Begin met het toevoegen van je eerste menucategorie</p>
        <button 
          onclick="document.getElementById('new-category-name').focus()"
          class="bg-menu-burgundy text-white px-8 py-3 rounded-xl font-bebas uppercase text-lg hover:bg-menu-brown transition-colors"
        >
          Categorie Aanmaken
        </button>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-2xl p-8 max-w-md mx-4 shadow-2xl">
      <div class="text-center">
        <div class="bg-red-100 p-4 rounded-full w-16 h-16 mx-auto mb-4 flex items-center justify-center">
          <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
        </div>
        <h3 class="text-xl font-bebas uppercase text-gray-800 mb-2">Verwijdering Bevestigen</h3>
        <p id="confirm-message" class="text-gray-600 mb-6"></p>
        <div class="flex space-x-4">
          <button 
            id="confirm-cancel"
            class="flex-1 bg-gray-200 text-gray-800 px-6 py-3 rounded-xl font-semibold hover:bg-gray-300 transition-colors"
          >
            Annuleren
          </button>
          <button 
            id="confirm-delete"
            class="flex-1 bg-red-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-red-700 transition-colors"
          >
            Verwijderen
          </button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, doc, getDocs, setDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAqmesvJgvRnZHm1777niBFRBjj0P_SBT0",
      authDomain: "clubtwee-menu.firebaseapp.com",
      projectId: "clubtwee-menu",
      storageBucket: "clubtwee-menu.firebasestorage.app",
      messagingSenderId: "852997452508",
      appId: "1:852997452508:web:763f2e7f820b5509da3a19"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Global state
    let currentCategories = [];
    let totalItems = 0;

    // Utility Functions
    function showLoading() {
      document.getElementById('loading-overlay').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loading-overlay').classList.add('hidden');
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
      const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
      
      toast.className = `${bgColor} text-white px-6 py-4 rounded-xl shadow-lg flex items-center space-x-3`;
      toast.innerHTML = `
        <i class="fas ${icon}"></i>
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" class="ml-4 hover:bg-white hover:bg-opacity-20 p-1 rounded">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      document.getElementById('toast-container').appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 5000);
    }

    function updateStats() {
      document.getElementById('total-categories').textContent = `${currentCategories.length} categorie${currentCategories.length !== 1 ? 'ën' : ''}`;
      document.getElementById('total-items').textContent = `${totalItems} item${totalItems !== 1 ? 's' : ''}`;
    }

    function validateInput(value, type = 'text') {
      if (type === 'text') {
        return value && value.trim().length >= 1;
      }
      if (type === 'price') {
        return !isNaN(value) && parseFloat(value) >= 0;
      }
      return false;
    }

    // Sanitize input - remove slashes to prevent Firestore path issues
    function sanitizeInput(input) {
      return input.trim().replace(/[<>\/\\]/g, '-');
    }

    // Confirmation Modal
    function showConfirmModal(message, onConfirm) {
      const modal = document.getElementById('confirm-modal');
      const messageEl = document.getElementById('confirm-message');
      const confirmBtn = document.getElementById('confirm-delete');
      const cancelBtn = document.getElementById('confirm-cancel');

      messageEl.textContent = message;
      modal.classList.remove('hidden');

      const handleConfirm = () => {
        onConfirm();
        modal.classList.add('hidden');
        confirmBtn.removeEventListener('click', handleConfirm);
        cancelBtn.removeEventListener('click', handleCancel);
      };

      const handleCancel = () => {
        modal.classList.add('hidden');
        confirmBtn.removeEventListener('click', handleConfirm);
        cancelBtn.removeEventListener('click', handleCancel);
      };

      confirmBtn.addEventListener('click', handleConfirm);
      cancelBtn.addEventListener('click', handleCancel);
    }

    // Load and Display Menu
    async function loadMenu() {
      showLoading();
      try {
        const menuContainer = document.getElementById('menu-container');
        const emptyState = document.getElementById('empty-state');
        
        menuContainer.innerHTML = '';
        currentCategories = [];
        totalItems = 0;

        const menuSnap = await getDocs(collection(db, "menus"));
        
        if (menuSnap.empty) {
          emptyState.classList.remove('hidden');
          hideLoading();
          updateStats();
          return;
        }

        emptyState.classList.add('hidden');

        for (let categoryDoc of menuSnap.docs) {
          const catName = categoryDoc.id;
          currentCategories.push(catName);
          
          const itemsSnap = await getDocs(collection(db, `menus/${catName}/items`));
          totalItems += itemsSnap.size;

          const categoryCard = createCategoryCard(catName, itemsSnap);
          menuContainer.appendChild(categoryCard);
        }

        updateStats();
      } catch (error) {
        console.error('Fout bij laden:', error);
        showToast('Fout bij het laden van het menu', 'error');
      }
      hideLoading();
    }

    function createCategoryCard(catName, itemsSnap) {
      const card = document.createElement('div');
      card.className = 'bg-menu-cream rounded-2xl shadow-lg border-2 border-menu-burgundy overflow-hidden';
      
      let itemsHTML = '';
      const items = [];
      
      itemsSnap.forEach(itemDoc => {
        const data = itemDoc.data();
        items.push({ 
          name: itemDoc.id, 
          price: data.price,
          description: data.description || ''
        });
      });

      items.sort((a, b) => a.name.localeCompare(b.name));

      items.forEach(item => {
        itemsHTML += `
          <div class="flex items-center justify-between py-3 px-6 border-b border-menu-burgundy border-opacity-20 hover:bg-white transition-colors group">
            <div class="flex-1 min-w-0 mr-4">
              <span class="text-lg font-semibold text-menu-burgundy block truncate">${item.name}</span>
              ${item.description ? `<span class="text-sm text-gray-500 block truncate">${item.description}</span>` : ''}
            </div>
            <div class="flex items-center space-x-3 flex-shrink-0">
              <div class="flex items-center space-x-1">
                <span class="text-sm text-gray-500">€</span>
                <input 
                  type="number" 
                  value="${item.price}" 
                  step="0.1" 
                  min="0"
                  class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-center font-medium focus:border-menu-burgundy focus:outline-none"
                  onchange="updateItemPrice('${catName}', '${item.name}', this.value)"
                >
              </div>
              <button 
                onclick="deleteItemWithConfirm('${catName}', '${item.name}')"
                class="bg-red-100 text-red-600 p-2 rounded-lg hover:bg-red-200 transition-colors"
                title="Item verwijderen"
              >
                <i class="fas fa-trash text-sm"></i>
              </button>
            </div>
          </div>
        `;
      });

      // Escape single quotes in category name for onclick handlers
      const escapedCatName = catName.replace(/'/g, "\\'");

      card.innerHTML = `
        <div class="bg-menu-burgundy text-white p-5">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
              <div class="bg-white bg-opacity-20 p-2 rounded-full">
                <i class="fas fa-folder text-lg"></i>
              </div>
              <div>
                <h3 class="text-2xl font-bebas uppercase">${catName}</h3>
                <p class="text-white text-opacity-80 text-sm">${items.length} item${items.length !== 1 ? 's' : ''}</p>
              </div>
            </div>
            <button 
              onclick="deleteCategoryWithConfirm('${escapedCatName}')"
              class="bg-white bg-opacity-20 text-white p-2 rounded-full hover:bg-opacity-30 transition-colors"
              title="Categorie verwijderen"
            >
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        
        <div class="max-h-96 overflow-y-auto">
          ${itemsHTML || '<p class="p-6 text-gray-500 text-center">Geen items in deze categorie</p>'}
        </div>
        
        <div class="p-4 bg-white border-t-2 border-menu-burgundy border-opacity-20">
          <p class="text-sm text-menu-burgundy font-semibold mb-3">Nieuw item toevoegen:</p>
          <div class="flex flex-col lg:flex-row gap-3">
            <input 
              id="name-${catName}" 
              type="text"
              placeholder="Naam" 
              class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:border-menu-burgundy focus:outline-none"
            >
            <input 
              id="price-${catName}" 
              type="number" 
              placeholder="Prijs" 
              step="0.1" 
              min="0"
              class="w-24 px-3 py-2 border border-gray-300 rounded-lg focus:border-menu-burgundy focus:outline-none"
            >
            <input 
              id="desc-${catName}" 
              type="text" 
              placeholder="Beschrijving (optioneel)" 
              class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:border-menu-burgundy focus:outline-none"
            >
            <button 
              onclick="addItem('${escapedCatName}')"
              class="bg-green-600 text-white px-4 py-2 rounded-lg font-bebas uppercase hover:bg-green-700 transition-colors flex items-center justify-center space-x-2"
            >
              <i class="fas fa-plus"></i>
              <span>Toevoegen</span>
            </button>
          </div>
        </div>
      `;

      return card;
    }

    // CRUD Operations
    window.addItem = async function(category) {
      const nameInput = document.getElementById(`name-${category}`);
      const priceInput = document.getElementById(`price-${category}`);
      const descInput = document.getElementById(`desc-${category}`);

      const name = sanitizeInput(nameInput.value);
      const price = parseFloat(priceInput.value);
      const description = descInput.value.trim();

      if (!validateInput(name)) {
        showToast("Vul een geldige naam in", "error");
        nameInput.focus();
        return;
      }

      if (!validateInput(price, 'price')) {
        showToast("Vul een geldige prijs in", "error");
        priceInput.focus();
        return;
      }

      showLoading();
      try {
        const itemRef = doc(db, `menus/${category}/items/${name}`);
        await setDoc(itemRef, {
          price,
          description
        });
        showToast(`"${name}" toegevoegd!`);
        nameInput.value = "";
        priceInput.value = "";
        descInput.value = "";
        loadMenu();
      } catch (error) {
        console.error(error);
        showToast("Fout bij het toevoegen van item", "error");
      }
      hideLoading();
    };

    window.updateItemPrice = async function(category, name, newPrice) {
      const price = parseFloat(newPrice);
      
      if (!validateInput(price, 'price')) {
        showToast('Ongeldige prijs', 'error');
        await loadMenu();
        return;
      }

      try {
        // Get existing data first
        const itemsSnap = await getDocs(collection(db, `menus/${category}/items`));
        let existingData = {};
        itemsSnap.forEach(doc => {
          if (doc.id === name) {
            existingData = doc.data();
          }
        });

        await setDoc(doc(db, `menus/${category}/items`, name), { 
          price,
          description: existingData.description || ''
        });
        showToast('Prijs bijgewerkt!');
      } catch (error) {
        console.error('Fout bij bijwerken:', error);
        showToast('Fout bij het bijwerken van de prijs', 'error');
      }
    }

    window.deleteItemWithConfirm = function(category, name) {
      showConfirmModal(
        `Weet je zeker dat je "${name}" wilt verwijderen?`,
        () => deleteItem(category, name)
      );
    }

    async function deleteItem(category, name) {
      try {
        showLoading();
        await deleteDoc(doc(db, `menus/${category}/items`, name));
        showToast(`"${name}" verwijderd!`);
        await loadMenu();
      } catch (error) {
        console.error('Fout bij verwijderen:', error);
        showToast('Fout bij het verwijderen van item', 'error');
        hideLoading();
      }
    }

    window.deleteCategoryWithConfirm = function(category) {
      showConfirmModal(
        `Weet je zeker dat je de categorie "${category}" en alle items wilt verwijderen?`,
        () => deleteCategory(category)
      );
    }

    async function deleteCategory(category) {
      try {
        showLoading();
        const batch = writeBatch(db);
        
        // Delete all items in the category
        const itemsSnap = await getDocs(collection(db, `menus/${category}/items`));
        itemsSnap.forEach(itemDoc => {
          batch.delete(itemDoc.ref);
        });
        
        // Delete the category document
        batch.delete(doc(db, "menus", category));
        
        await batch.commit();
        showToast(`Categorie "${category}" verwijderd!`);
        await loadMenu();
      } catch (error) {
        console.error('Fout bij verwijderen categorie:', error);
        showToast('Fout bij het verwijderen van de categorie', 'error');
        hideLoading();
      }
    }

    // Category Form Handler
    document.getElementById('category-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const nameEl = document.getElementById('new-category-name');
      const catName = sanitizeInput(nameEl.value);
      
      if (!validateInput(catName, 'text')) {
        showToast('Categorienaam moet minstens 1 karakter bevatten', 'error');
        nameEl.focus();
        return;
      }

      if (currentCategories.map(c => c.toLowerCase()).includes(catName.toLowerCase())) {
        showToast('Deze categorie bestaat al', 'error');
        nameEl.focus();
        return;
      }

      try {
        showLoading();
        await setDoc(doc(db, "menus", catName), { created: new Date() });
        nameEl.value = '';
        showToast(`Categorie "${catName}" aangemaakt!`);
        await loadMenu();
      } catch (error) {
        console.error('Fout bij aanmaken categorie:', error);
        showToast('Fout bij het aanmaken van de categorie', 'error');
        hideLoading();
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadMenu();
      
      // Keyboard shortcut to reload
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'r') {
          e.preventDefault();
          loadMenu();
          showToast('Menu herladen!', 'info');
        }
      });
    });
  </script>
</body>
</html>