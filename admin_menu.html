<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administration Menu - Club Twee</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'club-bg': '#f8f4f0',
            'club-pink': '#f4c2c2',
            'club-red': '#d44545',
            'club-brown': '#8b4513'
          },
          fontFamily: {
            'bebas': ['Bebas Neue', 'cursive']
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in-out',
            'slide-up': 'slideUp 0.3s ease-out',
            'shake': 'shake 0.5s ease-in-out',
            'pulse-slow': 'pulse 2s infinite'
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideUp {
      from { transform: translateY(100px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    .gradient-bg {
      background: linear-gradient(135deg, #f8f4f0 0%, #f4c2c2 50%, #f8f4f0 100%);
    }
  </style>
</head>
<body class="gradient-bg min-h-screen">
  <!-- Header -->
  <header class="bg-gradient-to-r from-club-brown to-club-red text-white shadow-2xl">
    <div class="max-w-7xl mx-auto px-6 py-8">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <div class="bg-white bg-opacity-20 p-3 rounded-full">
            <i class="fas fa-utensils text-2xl"></i>
          </div>
          <div>
            <h1 class="text-3xl md:text-4xl font-bebas uppercase tracking-wide">Addn and delete items Menu</h1>
            <p class="text-white text-opacity-80">Club twee menu</p>
          </div>
        </div>
        <div class="hidden md:flex items-center space-x-4">
          <div class="bg-white bg-opacity-20 px-4 py-2 rounded-full">
            <span id="total-items" class="font-bebas text-xl">0 items</span>
          </div>
          <div class="bg-white bg-opacity-20 px-4 py-2 rounded-full">
            <span id="total-categories" class="font-bebas text-xl">0 categories</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-xl p-8 flex flex-col items-center space-y-4">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-club-red"></div>
      <p class="font-bebas text-xl text-club-brown">Loading</p>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div id="toast-container" class="fixed top-4 right-4 z-40 space-y-2"></div>

  <div class="max-w-7xl mx-auto px-6 py-8">
    <!-- Add Category Section -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 border border-club-pink border-opacity-30">
      <div class="flex items-center space-x-4 mb-6">
        <div class="bg-gradient-to-r from-club-red to-club-brown p-3 rounded-full text-white">
          <i class="fas fa-plus text-xl"></i>
        </div>
        <h2 class="text-2xl font-bebas uppercase text-club-brown">Add a category</h2>
      </div>
      
      <form id="category-form" class="flex flex-col md:flex-row gap-4">
        <div class="flex-1">
          <input 
            id="new-category-name" 
            type="text"
            placeholder="Category (Broodjes, Dranken, Desserts,...)" 
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-club-red focus:outline-none transition-colors duration-300 text-lg"
            required
          >
        </div>
        <button 
          type="submit"
          class="bg-gradient-to-r from-club-red to-club-brown text-white px-8 py-3 rounded-xl font-bebas uppercase text-lg hover:shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center space-x-2"
        >
          <i class="fas fa-plus"></i>
          <span>Add category</span>
        </button>
      </form>
    </div>

    <!-- Menu Categories -->
    <div id="menu-container" class="space-y-8">
      <!-- Categories will be loaded here -->
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="text-center py-16 hidden">
      <div class="bg-white rounded-2xl shadow-xl p-12 border border-club-pink border-opacity-30">
        <i class="fas fa-utensils text-6xl text-club-pink mb-6"></i>
        <h3 class="text-3xl font-bebas uppercase text-club-brown mb-4">Aucune catégorie trouvée</h3>
        <p class="text-gray-600 text-lg mb-8">Commencez par ajouter votre première catégorie de menu</p>
        <button 
          onclick="document.getElementById('new-category-name').focus()"
          class="bg-gradient-to-r from-club-red to-club-brown text-white px-8 py-3 rounded-xl font-bebas uppercase text-lg hover:shadow-lg transform hover:scale-105 transition-all duration-300"
        >
          Créer une catégorie
        </button>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-2xl p-8 max-w-md mx-4 shadow-2xl">
      <div class="text-center">
        <div class="bg-red-100 p-4 rounded-full w-16 h-16 mx-auto mb-4 flex items-center justify-center">
          <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
        </div>
        <h3 class="text-xl font-bebas uppercase text-gray-800 mb-2">Confirmer la suppression</h3>
        <p id="confirm-message" class="text-gray-600 mb-6"></p>
        <div class="flex space-x-4">
          <button 
            id="confirm-cancel"
            class="flex-1 bg-gray-200 text-gray-800 px-6 py-3 rounded-xl font-semibold hover:bg-gray-300 transition-colors duration-300"
          >
            Annuler
          </button>
          <button 
            id="confirm-delete"
            class="flex-1 bg-red-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-red-700 transition-colors duration-300"
          >
            Supprimer
          </button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, doc, getDocs, setDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAqmesvJgvRnZHm1777niBFRBjj0P_SBT0",
      authDomain: "clubtwee-menu.firebaseapp.com",
      projectId: "clubtwee-menu",
      storageBucket: "clubtwee-menu.firebasestorage.app",
      messagingSenderId: "852997452508",
      appId: "1:852997452508:web:763f2e7f820b5509da3a19"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Global state
    let currentCategories = [];
    let totalItems = 0;

    // Utility Functions
    function showLoading() {
      document.getElementById('loading-overlay').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loading-overlay').classList.add('hidden');
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
      const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
      
      toast.className = `${bgColor} text-white px-6 py-4 rounded-xl shadow-lg flex items-center space-x-3 animate-slide-up transform transition-all duration-300`;
      toast.innerHTML = `
        <i class="fas ${icon}"></i>
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" class="ml-4 hover:bg-white hover:bg-opacity-20 p-1 rounded">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      document.getElementById('toast-container').appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 5000);
    }

    function updateStats() {
      document.getElementById('total-categories').textContent = `${currentCategories.length} catégorie${currentCategories.length !== 1 ? 's' : ''}`;
      document.getElementById('total-items').textContent = `${totalItems} item${totalItems !== 1 ? 's' : ''}`;
    }

    function validateInput(value, type = 'text') {
      if (type === 'text') {
        return value && value.trim().length >= 2;
      }
      if (type === 'price') {
        return !isNaN(value) && parseFloat(value) >= 0;
      }
      return false;
    }

    function sanitizeInput(input) {
      return input.trim().replace(/[<>]/g, '');
    }

    // Confirmation Modal
    function showConfirmModal(message, onConfirm) {
      const modal = document.getElementById('confirm-modal');
      const messageEl = document.getElementById('confirm-message');
      const confirmBtn = document.getElementById('confirm-delete');
      const cancelBtn = document.getElementById('confirm-cancel');

      messageEl.textContent = message;
      modal.classList.remove('hidden');

      const handleConfirm = () => {
        onConfirm();
        modal.classList.add('hidden');
        confirmBtn.removeEventListener('click', handleConfirm);
        cancelBtn.removeEventListener('click', handleCancel);
      };

      const handleCancel = () => {
        modal.classList.add('hidden');
        confirmBtn.removeEventListener('click', handleConfirm);
        cancelBtn.removeEventListener('click', handleCancel);
      };

      confirmBtn.addEventListener('click', handleConfirm);
      cancelBtn.addEventListener('click', handleCancel);
    }

    // Load and Display Menu
    async function loadMenu() {
      showLoading();
      try {
        const menuContainer = document.getElementById('menu-container');
        const emptyState = document.getElementById('empty-state');
        
        menuContainer.innerHTML = '';
        currentCategories = [];
        totalItems = 0;

        const menuSnap = await getDocs(collection(db, "menus"));
        
        if (menuSnap.empty) {
          emptyState.classList.remove('hidden');
          hideLoading();
          updateStats();
          return;
        }

        emptyState.classList.add('hidden');

        for (let categoryDoc of menuSnap.docs) {
          const catName = categoryDoc.id;
          currentCategories.push(catName);
          
          const itemsSnap = await getDocs(collection(db, `menus/${catName}/items`));
          totalItems += itemsSnap.size;

          const categoryCard = createCategoryCard(catName, itemsSnap);
          menuContainer.appendChild(categoryCard);
        }

        updateStats();
      } catch (error) {
        console.error('Erreur lors du chargement:', error);
        showToast('Erreur lors du chargement du menu', 'error');
      }
      hideLoading();
    }

    function createCategoryCard(catName, itemsSnap) {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-2xl shadow-xl border border-club-pink border-opacity-30 overflow-hidden animate-fade-in';
      
      let itemsHTML = '';
      const items = [];
      
      itemsSnap.forEach(itemDoc => {
        const data = itemDoc.data();
        items.push({ name: itemDoc.id, price: data.price });
      });

      items.sort((a, b) => a.name.localeCompare(b.name));

      items.forEach(item => {
        itemsHTML += `
          <div class="flex items-center justify-between py-4 px-6 border-b border-gray-100 hover:bg-club-pink hover:bg-opacity-10 transition-colors duration-300 group">
            <div class="flex-1">
              <span class="text-lg font-medium text-gray-800 group-hover:text-club-brown transition-colors duration-300">${item.name}</span>
            </div>
            <div class="flex items-center space-x-3">
              <div class="flex items-center space-x-2">
                <span class="text-sm text-gray-500">€</span>
                <input 
                  type="number" 
                  value="${item.price}" 
                  step="0.1" 
                  min="0"
                  class="w-20 px-3 py-2 border border-gray-200 rounded-lg text-center font-medium focus:border-club-red focus:outline-none transition-colors duration-300"
                  onchange="updateItemPrice('${catName}', '${item.name}', this.value)"
                >
              </div>
              <button 
                onclick="deleteItemWithConfirm('${catName}', '${item.name}')"
                class="bg-red-100 text-red-600 p-2 rounded-lg hover:bg-red-200 transition-colors duration-300"
                title="Supprimer cet item"
              >
                <i class="fas fa-trash text-sm"></i>
              </button>
            </div>
          </div>
        `;
      });

      card.innerHTML = `
        <div class="bg-gradient-to-r from-club-red to-club-brown text-white p-6">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
              <div class="bg-white bg-opacity-20 p-3 rounded-full">
                <i class="fas fa-utensils text-xl"></i>
              </div>
              <div>
                <h3 class="text-2xl font-bebas uppercase">${catName}</h3>
                <p class="text-white text-opacity-80">${items.length} item${items.length !== 1 ? 's' : ''}</p>
              </div>
            </div>
            <button 
              onclick="deleteCategoryWithConfirm('${catName}')"
              class="bg-white bg-opacity-20 text-white p-3 rounded-full hover:bg-opacity-30 transition-all duration-300"
              title="Supprimer cette catégorie"
            >
              <i class="fas fa-trash text-lg"></i>
            </button>
          </div>
        </div>
        
        <div class="divide-y divide-gray-100">
          ${itemsHTML}
        </div>
        
        <div class="p-6 bg-gray-50">
          <div class="flex flex-col md:flex-row gap-4">
            <input 
              id="name-${catName}" 
              type="text"
              placeholder="Item name" 
              class="flex-1 px-4 py-3 border border-gray-200 rounded-xl focus:border-club-red focus:outline-none transition-colors duration-300"
            >
            <input 
              id="price-${catName}" 
              type="number" 
              placeholder="Price" 
              step="0.1" 
              min="0"
              class="w-32 px-4 py-3 border border-gray-200 rounded-xl focus:border-club-red focus:outline-none transition-colors duration-300"
            >
            <input 
              id="desc-${catName}" 
              type="text" 
              placeholder="Description" 
              class="flex-1 px-4 py-3 border border-gray-200 rounded-xl focus:border-club-red focus:outline-none transition-colors duration-300"
            >
            <button 
              onclick="addItem('${catName}')"
              class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-xl font-bebas uppercase hover:shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center justify-center space-x-2"
            >
              <i class="fas fa-plus"></i>
              <span>Add</span>
            </button>
          </div>
        </div>
      `;

      return card;
    }

    // CRUD Operations
    window.addItem = async function(category) {
      const nameInput = document.getElementById(`name-${category}`);
      const priceInput = document.getElementById(`price-${category}`);
      const descInput = document.getElementById(`desc-${category}`);

      const name = sanitizeInput(nameInput.value);
      const price = parseFloat(priceInput.value);
      const description = sanitizeInput(descInput.value);

      if (!validateInput(name)) {
        showToast("Nom invalide pour l'item", "error");
        return;
      }

      if (!validateInput(price, 'price')) {
        showToast("Prix invalide", "error");
        return;
      }

      if (!validateInput(description)) {
        showToast("Description invalide", "error");
        return;
      }

      showLoading();
      try {
        const itemRef = doc(db, `menus/${category}/items/${name}`);
        await setDoc(itemRef, {
          price,
          description
        });
        showToast(`Item "${name}" ajouté avec succès`);
        nameInput.value = "";
        priceInput.value = "";
        descInput.value = "";
        loadMenu();
      } catch (error) {
        console.error(error);
        showToast("Erreur lors de l'ajout de l'item", "error");
      }
      hideLoading();
    };


    window.updateItemPrice = async function(category, name, newPrice) {
      const price = parseFloat(newPrice);
      
      if (!validateInput(price, 'price')) {
        showToast('Prix invalide', 'error');
        await loadMenu(); // Reload to reset the input
        return;
      }

      try {
        await setDoc(doc(db, `menus/${category}/items`, name), { price });
        showToast('Prix mis à jour!');
      } catch (error) {
        console.error('Erreur lors de la mise à jour:', error);
        showToast('Erreur lors de la mise à jour du prix', 'error');
      }
    }

    window.deleteItemWithConfirm = function(category, name) {
      showConfirmModal(
        `Êtes-vous sûr de vouloir supprimer "${name}" ?`,
        () => deleteItem(category, name)
      );
    }

    async function deleteItem(category, name) {
      try {
        showLoading();
        await deleteDoc(doc(db, `menus/${category}/items`, name));
        showToast(`"${name}" supprimé avec succès!`);
        await loadMenu();
      } catch (error) {
        console.error('Erreur lors de la suppression:', error);
        showToast('Erreur lors de la suppression de l\'item', 'error');
        hideLoading();
      }
    }

    window.deleteCategoryWithConfirm = function(category) {
      showConfirmModal(
        `Êtes-vous sûr de vouloir supprimer la catégorie "${category}" et tous ses items ?`,
        () => deleteCategory(category)
      );
    }

    async function deleteCategory(category) {
      try {
        showLoading();
        const batch = writeBatch(db);
        
        // Delete all items in the category
        const itemsSnap = await getDocs(collection(db, `menus/${category}/items`));
        itemsSnap.forEach(itemDoc => {
          batch.delete(itemDoc.ref);
        });
        
        // Delete the category document
        batch.delete(doc(db, "menus", category));
        
        await batch.commit();
        showToast(`Catégorie "${category}" supprimée avec succès!`);
        await loadMenu();
      } catch (error) {
        console.error('Erreur lors de la suppression de la catégorie:', error);
        showToast('Erreur lors de la suppression de la catégorie', 'error');
        hideLoading();
      }
    }

    // Category Form Handler
    document.getElementById('category-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const nameEl = document.getElementById('new-category-name');
      const catName = sanitizeInput(nameEl.value);
      
      if (!validateInput(catName, 'text')) {
        nameEl.classList.add('animate-shake', 'border-red-500');
        setTimeout(() => {
          nameEl.classList.remove('animate-shake', 'border-red-500');
        }, 500);
        showToast('Le nom de la catégorie doit contenir au moins 2 caractères', 'error');
        return;
      }

      if (currentCategories.includes(catName)) {
        nameEl.classList.add('animate-shake', 'border-red-500');
        setTimeout(() => {
          nameEl.classList.remove('animate-shake', 'border-red-500');
        }, 500);
        showToast('Cette catégorie existe déjà', 'error');
        return;
      }

      try {
        showLoading();
        await setDoc(doc(db, "menus", catName), { created: new Date() });
        nameEl.value = '';
        showToast(`Catégorie "${catName}" créée avec succès!`);
        await loadMenu();
      } catch (error) {
        console.error('Erreur lors de la création de la catégorie:', error);
        showToast('Erreur lors de la création de la catégorie', 'error');
        hideLoading();
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadMenu();
      
      // Add keyboard shortcuts
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'r') {
          e.preventDefault();
          loadMenu();
          showToast('Menu rechargé!', 'info');
        }
      });
    });
  </script>
</body>
</html>